---
import BaseLayout from "../layouts/BaseLayout.astro";
import ResearchAreaCard from "../components/ResearchAreaCard.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import "../styles/app.css";

// 1. Fetch Research Areas (Same logic as src/pages/Research/index.astro)
const researchAreas = Object.values(
    import.meta.glob("./Research/*.md", { eager: true }),
);

// Helper to resolve images for Research Areas (which use string paths in frontmatter)
const researchImages = import.meta.glob<{ default: ImageMetadata }>(
    "/src/assets/*.{jpeg,jpg,png,gif}",
    { eager: true },
);
const getResearchImage = (filename: string) => {
    return researchImages[`/src/assets/${filename}`]?.default;
};

// 2. Fetch Latest News
const allNews = await getCollection("news");
// Sort by date descending and take the top 3
const latestNews = allNews
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
    .slice(0, 3);
---

<BaseLayout>
    <section class="hero min-h-[50vh] bg-base-200 rounded-box mb-12">
        <div class="hero-content text-center">
            <div class="max-w-2xl">
                <h1 class="text-5xl font-bold mb-6">
                    Multidisciplinary AI Research Centre
                </h1>
                <p class="py-6 text-xl">
                    Pioneering the future of Artificial Intelligence through
                    innovative research in Biomedical Engineering, Computer
                    Vision, and Generative AI.
                </p>
                <div class="flex gap-4 justify-center">
                    <a href="/Research" class="btn btn-primary"
                        >Explore Research</a
                    >
                    <a href="/projects" class="btn btn-outline">View Projects</a
                    >
                </div>
            </div>
        </div>
    </section>

    <section class="mb-16">
        <h2 class="text-3xl font-bold mb-8 text-center">
            Our Research Pillars
        </h2>
        <div class="flex flex-col gap-8">
            {
                researchAreas.map((Area: any) => (
                    <ResearchAreaCard
                        Area={Area.frontmatter.title}
                        ImageUrl={getResearchImage(Area.frontmatter.coverImage)}
                        PageLink={Area.url}
                    >
                        {Area.frontmatter.short}
                    </ResearchAreaCard>
                ))
            }
        </div>
    </section>

    <section class="mb-12">
        <div class="flex justify-between items-end mb-8">
            <h2 class="text-3xl font-bold">Latest News</h2>
            <a href="/news" class="link link-primary">View All News â†’</a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {
                latestNews.map((newsItem) => (
                    <a
                        href={`/news/${newsItem.id}`}
                        class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow duration-300"
                    >
                        <figure class="px-4 pt-4">
                            {newsItem.data.cover && (
                                <Image
                                    src={newsItem.data.cover}
                                    alt={newsItem.data.title}
                                    class="rounded-xl h-48 w-full object-cover"
                                />
                            )}
                        </figure>
                        <div class="card-body">
                            <h3 class="card-title text-lg">
                                {newsItem.data.title}
                                {new Date(newsItem.data.date) >
                                    new Date(
                                        Date.now() - 30 * 24 * 60 * 60 * 1000,
                                    ) && (
                                    <div class="badge badge-secondary">NEW</div>
                                )}
                            </h3>
                            <p class="text-sm text-gray-500 mb-2">
                                {newsItem.data.date.toLocaleDateString(
                                    "en-US",
                                    {
                                        year: "numeric",
                                        month: "long",
                                        day: "numeric",
                                    },
                                )}
                            </p>
                            <p class="line-clamp-3 text-sm">
                                {newsItem.data.short}
                            </p>
                        </div>
                    </a>
                ))
            }
        </div>
    </section>
</BaseLayout>
