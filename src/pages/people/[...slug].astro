---
import { getCollection, render } from "astro:content";
import { Image } from "astro:assets";
import BaseLayout from "../../layouts/BaseLayout.astro";
import "../../styles/app.css";
import defaul_avatar from "../../assets/avatar_default.svg";
import Breadcrumb from "../../components/Breadcrumb.astro";

// --- Data Fetching Logic ---
export async function getStaticPaths() {
    const people = await getCollection("people");
    return people.map((person) => ({
        params: { slug: person.id },
        props: { person },
    }));
}

const projects = await getCollection("projects");
const { person } = Astro.props;
const { Content } = await render(person);

// 1. Filter Projects
const filtered_projects = projects.filter((project) => {
    return (
        project.data.projectMembers.includes(person.data.email) ||
        project.data.supervisors.includes(person.data.email)
    );
});

// 2. Filter & Sort Publications (Newest First)
const publications = await getCollection("publications");
const relevant_publications = publications
    .filter((pub) => pub.data.people.includes(person.data.email))
    .sort(
        (a, b) =>
            new Date(b.data.publication_date).getTime() -
            new Date(a.data.publication_date).getTime(),
    );
---

<BaseLayout>
    <div class="max-w-7xl mx-auto px-4 py-8">
        {/* Breadcrumbs */}
        <Breadcrumb>
            <li><a href="/">Home</a></li>
            <li><a href="/people">People</a></li>
            <li>{person.data.name}</li>
        </Breadcrumb>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 mt-8">
            {/* --- LEFT SIDEBAR: Personal Info --- */}
            <aside class="lg:col-span-4 space-y-6">
                <div
                    class="card bg-base-100 shadow-xl border border-base-200 sticky top-10"
                >
                    <div class="card-body items-center text-center">
                        <div class="avatar">
                            <div
                                class="w-48 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2 mb-4"
                            >
                                <Image
                                    src={person.data.photo ?? defaul_avatar}
                                    alt={person.data.name}
                                    width={200}
                                    height={200}
                                    class="object-cover"
                                />
                            </div>
                        </div>
                        <h1 class="card-title text-2xl font-bold">
                            {person.data.name}
                        </h1>

                        <div class="badge badge-secondary badge-outline mt-2">
                            {person.data.post}
                        </div>

                        <div class="divider my-4"></div>

                        <div class="w-full text-left space-y-3">
                            <div>
                                <h3
                                    class="text-xs font-bold uppercase text-base-content/50 mb-1"
                                >
                                    Contact
                                </h3>
                                <a
                                    href={`mailto:${person.data.email}`}
                                    class="flex items-center gap-2 hover:text-primary transition-colors text-sm break-all"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 20 20"
                                        fill="currentColor"
                                        class="w-4 h-4"
                                    >
                                        <path
                                            d="M3 4a2 2 0 00-2 2v1.161l8.441 4.221a1.25 1.25 0 001.118 0L19 7.162V6a2 2 0 00-2-2H3z"
                                        ></path>
                                        <path
                                            d="M19 8.839l-7.77 3.885a2.75 2.75 0 01-2.46 0L1 8.839V14a2 2 0 002 2h14a2 2 0 002-2V8.839z"
                                        ></path>
                                    </svg>
                                    {person.data.email}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            {/* --- RIGHT COLUMN: Bio, Projects & Publications --- */}
            <main class="lg:col-span-8 space-y-12">
                {/* 1. Biography */}
                <section>
                    <h2
                        class="text-3xl font-bold mb-6 border-b pb-2 border-base-300"
                    >
                        Biography
                    </h2>
                    <article
                        class="prose prose-lg max-w-none prose-headings:text-primary prose-a:text-primary"
                    >
                        <Content />
                    </article>
                </section>

                {/* 2. Associated Projects */}
                {
                    filtered_projects.length > 0 && (
                        <section>
                            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                                Associated Projects
                                <span class="badge badge-neutral">
                                    {filtered_projects.length}
                                </span>
                            </h2>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {filtered_projects.map((p) => (
                                    <a
                                        href={`/projects/${p.id}`}
                                        class="card bg-base-100 shadow-md border border-base-200 hover:shadow-xl hover:border-primary transition-all duration-300"
                                    >
                                        <div class="card-body p-6">
                                            <h3 class="card-title text-lg">
                                                {p.data.project}
                                            </h3>
                                            <p class="text-sm text-base-content/70 line-clamp-2">
                                                {p.data.researchArea ||
                                                    "View project details..."}
                                            </p>
                                            <div class="card-actions justify-end mt-4">
                                                <div class="badge badge-outline text-xs">
                                                    View Project &rarr;
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                ))}
                            </div>
                        </section>
                    )
                }

                {/* 3. Publications (NEW SECTION) */}
                {
                    relevant_publications.length > 0 && (
                        <section>
                            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                                Publications
                                <span class="badge badge-neutral">
                                    {relevant_publications.length}
                                </span>
                            </h2>

                            <div class="space-y-4">
                                {relevant_publications.map((pub) => (
                                    <div class="card bg-base-100 shadow-sm border border-base-200">
                                        <div class="card-body p-5">
                                            {/* Header: Date & Type */}
                                            <div class="flex items-center gap-2 mb-1">
                                                <div
                                                    class={`badge ${pub.data.type === "Journal" ? "badge-secondary" : "badge-accent"} badge-outline text-xs font-bold uppercase`}
                                                >
                                                    {pub.data.type}
                                                </div>
                                                <span class="text-xs text-base-content/50">
                                                    {pub.data.publication_date}
                                                </span>
                                            </div>

                                            {/* Title */}
                                            <h3 class="text-lg font-bold hover:text-primary transition-colors">
                                                <a
                                                    href={pub.data.doi}
                                                    target="_blank"
                                                >
                                                    {pub.data.paper_title}
                                                </a>
                                            </h3>

                                            {/* Venue */}
                                            <p class="text-sm text-base-content/80 italic">
                                                {pub.data.venue}
                                            </p>

                                            {/* Actions */}
                                            <div class="card-actions justify-end mt-2">
                                                <a
                                                    href={pub.data.doi}
                                                    target="_blank"
                                                    class="link link-primary text-xs font-bold flex items-center gap-1"
                                                >
                                                    Read Paper
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        viewBox="0 0 20 20"
                                                        fill="currentColor"
                                                        class="w-3 h-3"
                                                    >
                                                        <path
                                                            fill-rule="evenodd"
                                                            d="M5 10a.75.75 0 01.75-.75h6.638L10.23 7.29a.75.75 0 111.04-1.08l3.5 3.5a.75.75 0 010 1.08l-3.5 3.5a.75.75 0 11-1.04-1.08l2.158-1.96H5.75A.75.75 0 015 10z"
                                                            clip-rule="evenodd"
                                                        />
                                                    </svg>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    )
                }
            </main>
        </div>
    </div>
</BaseLayout>
