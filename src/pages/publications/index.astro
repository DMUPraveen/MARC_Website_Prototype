---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Breadcrumb from "../../components/Breadcrumb.astro";
import { getCollection } from "astro:content";

const publications = await getCollection("publications");

// Sort by Date (Newest first)
const sortedPublications = publications.sort(
    (a, b) =>
        new Date(b.data.publication_date).getTime() -
        new Date(a.data.publication_date).getTime(),
);

// Group by Year
const publicationsByYear = sortedPublications.reduce(
    (acc, pub) => {
        const year = new Date(pub.data.publication_date).getFullYear();
        if (!acc[year]) {
            acc[year] = [];
        }
        acc[year].push(pub);
        return acc;
    },
    {} as Record<string, typeof publications>,
);

const years = Object.keys(publicationsByYear).sort(
    (a, b) => Number(b) - Number(a),
);
---

<BaseLayout title="Publications">
    <div class="max-w-5xl mx-auto px-4 py-8">
        <Breadcrumb>
            <li><a href="/">Home</a></li>
            <li>Publications</li>
        </Breadcrumb>

        <div class="mb-12 text-center">
            <h1 class="text-5xl font-bold mb-4 text-primary">Publications</h1>
            <p class="text-lg text-base-content/70">
                Our latest contributions to Journals and Conferences.
            </p>
        </div>

        <div class="space-y-12">
            {
                years.map((year) => (
                    <section class="relative">
                        <div class="sticky top-4 z-10 mb-6">
                            <span class="text-6xl font-black text-base-200 select-none absolute -top-8 -left-4 -z-10">
                                {year}
                            </span>
                            <h2 class="text-3xl font-bold border-l-4 border-primary pl-4 py-1 bg-base-100/80 backdrop-blur-sm">
                                {year}
                            </h2>
                        </div>

                        <div class="grid gap-6">
                            {publicationsByYear[year].map((pub) => (
                                <div class="card bg-base-100 shadow-sm border border-base-200 hover:shadow-md transition-shadow">
                                    <div class="card-body p-6">
                                        <div class="flex flex-col md:flex-row gap-4 justify-between items-start">
                                            <div class="flex-1 space-y-2">
                                                {/* --- METADATA ROW --- */}
                                                <div class="flex flex-wrap gap-2 items-center mb-1">
                                                    {/* 1. Type Badge */}
                                                    <div
                                                        class={`badge ${pub.data.type === "Journal" ? "badge-secondary" : "badge-accent"} badge-outline text-xs font-bold uppercase tracking-wider`}
                                                    >
                                                        {pub.data.type}
                                                    </div>

                                                    {/* 2. Project Badge (NEW) */}
                                                    {pub.data.project && (
                                                        <div class="badge badge-ghost text-xs gap-1">
                                                            <svg
                                                                xmlns="http://www.w3.org/2000/svg"
                                                                viewBox="0 0 20 20"
                                                                fill="currentColor"
                                                                class="w-3 h-3 opacity-70"
                                                            >
                                                                <path d="M7 8a3 3 0 100-6 3 3 0 000 6zM14.5 9a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM1.615 16.428a1.224 1.224 0 01-.569-1.175 6.002 6.002 0 0111.908 0c.058.467-.172.92-.57 1.174A9.953 9.953 0 017 18a9.953 9.953 0 01-5.385-1.572zM14.5 16h-.106c.07-.297.088-.611.048-.933a7.47 7.47 0 00-1.588-3.755 4.502 4.502 0 015.874 2.636.818.818 0 01-.36.98A7.465 7.465 0 0114.5 16z" />
                                                            </svg>
                                                            {pub.data.project}
                                                        </div>
                                                    )}

                                                    <span class="text-xs text-base-content/50 font-mono">
                                                        |{" "}
                                                        {
                                                            pub.data
                                                                .publication_date
                                                        }
                                                    </span>
                                                </div>

                                                <h3 class="text-xl font-bold leading-tight">
                                                    <a
                                                        href={pub.data.doi}
                                                        target="_blank"
                                                        class="hover:text-primary transition-colors"
                                                    >
                                                        {pub.data.paper_title}
                                                    </a>
                                                </h3>

                                                <p class="text-sm font-medium text-base-content/80 italic">
                                                    {pub.data.venue}
                                                </p>

                                                <p class="text-sm text-base-content/60 leading-relaxed">
                                                    {pub.data.authors.map(
                                                        (author, index) => (
                                                            <span>
                                                                {author}
                                                                {index <
                                                                pub.data.authors
                                                                    .length -
                                                                    1
                                                                    ? ", "
                                                                    : ""}
                                                            </span>
                                                        ),
                                                    )}
                                                </p>
                                            </div>

                                            <div class="flex-shrink-0 pt-1">
                                                <a
                                                    href={pub.data.doi}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    class="btn btn-sm btn-outline btn-primary gap-2"
                                                >
                                                    Read Paper
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke-width="1.5"
                                                        stroke="currentColor"
                                                        class="w-4 h-4"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"
                                                        />
                                                    </svg>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>
                ))
            }
        </div>
    </div>
</BaseLayout>
