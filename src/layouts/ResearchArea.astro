---
import "../styles/app.css";
import BaseLayout from "./BaseLayout.astro";
import Breadcrumb from "../components/Breadcrumb.astro";
import type { ImageMetadata } from "astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";

const { frontmatter } = Astro.props;

// --- Image Handling Logic ---
// We keep your glob logic but add a safety check
const imagePath = frontmatter.coverImage;
const imageKey = `/src/assets/${imagePath}`;
const images = import.meta.glob<{ default: ImageMetadata }>(
    "/src/assets/*.{jpeg,jpg,png,gif}",
    { eager: true },
);

// Fallback if image isn't found
const heroImage = images[imageKey]?.default;
const backgroundUrl = heroImage ? `url(${heroImage.src})` : "none";

// --- Data Fetching ---
const projects = await getCollection("projects");
const relatedProjects = projects.filter(
    (project) => project.data.researchArea === frontmatter.title,
);
---

<style define:vars={{ backgroundUrl }}>
    .custom-hero-bg {
        background-image: var(--backgroundUrl);
    }
</style>

<BaseLayout>
    {/* Navigation */}
    <div class="max-w-5xl mx-auto px-4 pt-4">
        <Breadcrumb>
            <li><a href="/">Home</a></li>
            <li><a href="/Research">Research Areas</a></li>
            <li>{frontmatter.title}</li>
        </Breadcrumb>
    </div>

    <main class="max-w-5xl mx-auto px-4 py-8 pb-20">
        {/* --- HERO SECTION --- */}
        <div
            class="hero rounded-3xl overflow-hidden shadow-xl mb-12 min-h-[400px] custom-hero-bg bg-cover bg-center place-items-stretch"
        >
            <div class="hero-overlay bg-black/60"></div>
            <div
                class="hero-content text-center text-neutral-content flex flex-col justify-center h-full"
            >
                <div class="max-w-2xl px-4 py-8">
                    <h1
                        class="mb-5 text-4xl md:text-6xl font-extrabold tracking-tight text-white drop-shadow-lg"
                    >
                        {frontmatter.title}
                    </h1>
                    {
                        /* Optional: If you have a description in frontmatter, add it here */
                    }
                    {
                        frontmatter.description && (
                            <p class="text-lg md:text-xl text-gray-200">
                                {frontmatter.description}
                            </p>
                        )
                    }
                </div>
            </div>
        </div>

        {/* --- MAIN CONTENT --- */}
        <article
            class="prose prose-lg prose-headings:text-primary max-w-none mb-16"
        >
            <slot />
        </article>

        {/* --- RELATED PROJECTS SECTION --- */}
        {
            relatedProjects.length > 0 && (
                <section>
                    <div class="flex items-center gap-4 mb-8">
                        <h2 class="text-3xl font-bold text-base-content">
                            Related Projects
                        </h2>
                        <div class="h-px bg-base-300 flex-grow" />
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {relatedProjects.map((project) => (
                            <a
                                href={`/projects/${project.id}`}
                                class="card bg-base-100 shadow-sm border border-base-200 hover:shadow-xl hover:border-primary hover:-translate-y-1 transition-all duration-300 group"
                            >
                                <div class="card-body">
                                    <h3 class="card-title text-lg group-hover:text-primary transition-colors">
                                        {project.data.project}
                                    </h3>

                                    {/* Visual Pills for Tags */}
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        {project.data.researchPillars
                                            ?.slice(0, 3)
                                            .map((pillar: any) => (
                                                <span class="badge badge-sm badge-outline text-xs opacity-70">
                                                    {pillar}
                                                </span>
                                            ))}
                                        {project.data.researchPillars?.length >
                                            3 && (
                                            <span class="badge badge-sm badge-ghost text-xs">
                                                +
                                                {project.data.researchPillars
                                                    .length - 3}{" "}
                                                more
                                            </span>
                                        )}
                                    </div>

                                    <div class="card-actions justify-end mt-4">
                                        <span class="text-xs font-bold text-primary flex items-center gap-1">
                                            View Project
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                viewBox="0 0 20 20"
                                                fill="currentColor"
                                                class="w-4 h-4"
                                            >
                                                <path
                                                    fill-rule="evenodd"
                                                    d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.5a.75.75 0 010 1.08l-5.5 5.5a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z"
                                                    clip-rule="evenodd"
                                                />
                                            </svg>
                                        </span>
                                    </div>
                                </div>
                            </a>
                        ))}
                    </div>
                </section>
            )
        }
    </main>
</BaseLayout>
